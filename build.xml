<project default="generatezip">

<!--
  <fail message="Unsupported Java version: ${ant.java.version}. Make sure that the Java version is 1.8.">
    <condition>
      <not>
        <equals arg1="${ant.java.version}" arg2="1.8"/>
      </not>
  </condition>
  </fail>
-->

  <property name="rootdir" location="${basedir}"/>
  <property name="vtkrootdir" location="/home/kahneg1/src/near/vtk_all_platforms"/>

  <target name="compile">
    <echo>$${rootdir}=${rootdir}</echo>
    <mkdir dir="${rootdir}/build/classes"/>
    <mkdir dir="${rootdir}/build/classes/edu"/>
    <mkdir dir="${rootdir}/build/classes/edu/jhuapl"/>
    <mkdir dir="${rootdir}/build/classes/edu/jhuapl/near"/>
    <mkdir dir="${rootdir}/build/classes/edu/jhuapl/near/data"/>
    <exec executable="sh" output="build/classes/svn.version" failifexecutionfails="false">
      <arg value="-c"/>
      <!-- <arg value="svn info | grep -i 'Last Changed Date'"/> -->
      <arg value="echo Last Changed Date: `date +%F`"/>
    </exec>
    <copy todir="${rootdir}/build/classes/edu/jhuapl/near/data">
      <fileset dir="${rootdir}/src/edu/jhuapl/near/data"/>
    </copy>
    <javac srcdir="${rootdir}/src"
		   destdir="${rootdir}/build/classes"
		   debug="on" >
      <classpath>
        <fileset dir="${rootdir}/lib">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="jarapl" depends="compile">
    <mkdir dir="${rootdir}/build/jar"/>
    <path id="build-classpath">
      <fileset dir="${rootdir}/lib">
        <include name="**/*.jar" />
      </fileset>
    </path>
    <pathconvert property="manifest.classpath" pathsep=" ">
      <path refid="build-classpath"/>
      <mapper>
        <flattenmapper/>
      </mapper>
    </pathconvert>
    <jar destfile="${rootdir}/build/jar/near-apl.jar" basedir="${rootdir}/build/classes">
      <manifest>
        <attribute name="Class-Path" value="${manifest.classpath}"/>
        <attribute name="Main-Class" value="edu.jhuapl.near.tools.SmallBodyMappingToolAPL"/>
      </manifest>
    </jar>
  </target>

  <target name="jar" depends="compile">
    <mkdir dir="${rootdir}/build/jar"/>
    <path id="build-classpath">
      <fileset dir="${rootdir}/lib">
        <include name="**/*.jar" />
      </fileset>
    </path>
    <pathconvert property="manifest.classpath" pathsep=" ">
      <path refid="build-classpath"/>
      <mapper>
        <flattenmapper/>
      </mapper>
    </pathconvert>
    <jar destfile="${rootdir}/build/jar/near.jar">
      <fileset dir="${rootdir}/build/classes">
        <exclude name="edu/jhuapl/near/data/LinearFeatures.txt"/>
        <exclude name="edu/jhuapl/near/tools/**"/>
      </fileset>
      <fileset dir="${rootdir}/build/classes">
        <include name="edu/jhuapl/near/tools/SmallBodyMappingTool.class"/>
        <include name="edu/jhuapl/near/tools/SmallBodyMappingTool$*.class"/>
      </fileset>
      <manifest>
        <attribute name="Class-Path" value="${manifest.classpath}"/>
        <attribute name="Main-Class" value="edu.jhuapl.near.tools.SmallBodyMappingTool"/>
      </manifest>
    </jar>
  </target>

  <target name="generatezip" depends="jar,jarapl">
    <mkdir dir="${rootdir}/build/dist"/>
    <mkdir dir="${rootdir}/build/dist/internal"/>
    <mkdir dir="${rootdir}/build/dist/public"/>
    <exec executable="config/generate_zip_dist.sh">
      <arg value="/project/nearsdc/software/vtk_all_platforms"/>
      <arg value="${rootdir}/build/dist/internal"/>
      <arg value="-internal"/>
    </exec>
    <exec executable="config/generate_zip_dist.sh">
      <arg value="/project/nearsdc/software/vtk_all_platforms"/>
      <arg value="${rootdir}/build/dist/public"/>
      <arg value="-public"/>
    </exec>
  </target>

  <target name="runjarapl" depends="jarapl">
    <java classname="edu.jhuapl.near.tools.SmallBodyMappingToolAPL" fork="true"
          maxmemory="512m">
      <jvmarg value="-Djava.library.path=/project/nearsdc/software/vtk_all_platforms/current"/>
      <jvmarg value="-Dsun.java2d.noddraw=true"/>
      <jvmarg value="-Dcom.apple.mrj.application.apple.menu.about.name=Small Body Mapping Tool"/>
      <classpath>
        <fileset dir="${rootdir}/lib">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </java>
  </target>

  <target name="clean">
    <delete dir="${rootdir}/build"/>
  </target>

</project>
